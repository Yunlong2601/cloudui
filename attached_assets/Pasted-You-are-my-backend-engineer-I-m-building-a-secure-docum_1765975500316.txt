You are my backend engineer.
I’m building a secure document sharing web app called FortiFile using Python Flask + PostgreSQL (psycopg2 or SQLAlchemy). Please implement Yunlong’s security module in a clean, modular way.

0) Hard requirements

Use PostgreSQL and provide full DB schema + migrations (or schema.sql if easier).

Do NOT remove other features. Add new modules/routes/templates only.

Write clear comments and keep code organized by folders (e.g., auth/, rbac/, admin/).

1) Authentication + Session Handling

Implement server-side sessions (Flask-Login + session cookies) OR JWT (pick one and implement fully; I prefer server-side sessions if unsure).

Password hashing: bcrypt or Argon2.

Routes:

POST /auth/register

POST /auth/login

POST /auth/logout

GET /me (returns current user)

Add session expiry and protect private routes.

2) RBAC (Role-Based Access Control)

Create tables and code for:

users

roles

permissions

user_roles

role_permissions

Seed:

roles: admin, staff, student

permissions:

file.upload

file.download

file.share

admin.view_logs

admin.manage_roles

incident.manage

Implement:

has_permission(user_id, perm_name) helper

decorator: @require_permission("...") to protect routes

Admin APIs/UI to assign roles to users and edit role-permission mapping.

3) MAC (Mandatory Access Control)

Add security levels:

public, confidential, restricted

Rules:

Each user has clearance_level

Each file has classification_level

User can only access files at or below their clearance.

Enforce MAC checks in:

file view/download

file share

When blocked, return 403 and log it as a MAC denial.

4) Audit Logging (PostgreSQL)

Create table audit_logs with:

id (UUID)

created_at

user_id (nullable for unauth)

action (text)

target_type (text)

target_id (text/uuid)

ip

user_agent

result (success/fail)

details (jsonb)

Log these actions:

login success/fail

upload/download/share

RBAC denials

MAC denials

role/permission changes

incident create/update

Add useful indexes (created_at, user_id, action).

5) Admin Security Dashboard (Admin only)

Create a simple admin page:

/admin/logs to view audit logs

Filters: date range, user, action, result

Show “suspicious highlights”:

repeated failed logins

repeated MAC denials

6) Incident Reporting + Tracking

Create incidents table:

id UUID

created_at

created_by (user_id)

status (open, investigating, resolved)

severity (low, medium, high)

title

description

related_audit_log_id (nullable)

Admin routes:

POST /admin/incidents (create)

PATCH /admin/incidents/<id> (update status/severity)

Option: “Create incident from audit log entry” button/link.

7) Deliverables

Working Flask code with clear folder structure

PostgreSQL schema/migration + seed script

Minimal templates/pages for admin dashboard

A short README: how to run, set env vars, init DB, seed data, create admin user

Start by scaffolding the DB schema and auth first, then RBAC, then MAC, then audit logs, then admin dashboard, then incidents.